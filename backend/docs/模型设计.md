# 模型设计

## 实体类

- 用户(id，用户名，学号，密码，邮箱，头像，创建时间，最后登录时间，最后登录IP，状态)
- 餐馆(id，餐馆名，餐馆描述，餐馆地址，餐馆电话，餐馆图片，创建时间，更新时间, 创建者)
- 帖子(id，用户id，餐馆id，评价内容，评价时间，评价星级，推荐菜品，餐馆均价，点赞)
- 评论(id，用户id，帖子id，回复id，评论内容，评论时间，点赞)
- 菜品(id，菜品名)
- 地址(id，经度，纬度，地址名，关联内容)
- tag(id，标签名，创建者)

## 关系

- 关注用户（用户id，被关注用户id，创建时间，更新时间，创建者）
- 收藏餐馆（用户id，餐馆id，创建时间，更新时间，创建者）
- 用户帖子
- 用户评论
- 帖子评论
- 帖子菜品
- 评论评论
- 餐馆Tag
- 餐馆帖子
- 餐馆地址

## 代办

1. [.] 用户关注
2. [ ] 用户互发消息
3. [.] 推荐+创建模型：餐馆，推荐菜，Tag
4. [.] 用户帖子和评论实现
5. [.] 用户收藏餐馆和菜品
6. [.] 评论markdown支持：`npm install markdown-it --save`
7. [ ] 地图api：百度地图api，和前端协商
8. [.] 首页推荐算法：根据tag和关注来
9. [ ] 用户主页展示权限
10. [.] tag筛选餐馆的与逻辑
11. [.] 餐馆列表以及各种列表的排序
12. [.] getlist的均价和评分，以及造一个轮子
13. [ ] 举报功能
14. [ ] 消息通知

## 问题

- 发消息需要采取其他实现，先不管了

## api文档

### 用户

#### 用户注册 user/signup [post]

#### 用户登录 user/login [post]

#### 用户登出 user/logout [get]

#### 用户注销 user/delete [delete]

#### 用户更新信息 user/update-info [put]

#### 用户更新头像 user/update-avatar [put]

#### 用户更改密码 user/update-password [post]

#### 得到用户信息 user/get-user-info [get]

#### 刷新token user/refresh-token [get]

#### 发送验证码 user/send-captcha [post]

#### 更改邮箱 user/change-email [post]

#### 收藏餐馆 user/collect [post]

#### 取消收藏 user/uncollect [post]

#### 获取收藏的数目 user/get-collections-num [get]

#### 获取收藏的列表 user/get-collections-list [get]

### 餐馆 restaurant/

#### 创建餐馆 create_restaurant [post]

```json
{
    "name": "餐馆名",
    "address": "餐馆地址",
    "phone": "餐馆电话"
}
```

#### 得到餐馆信息 get_restaurant_detail/{id} [get]

```json
{
    "id": 2,
    "name": "潇湘阁",
    "description": "",
    "address": null,
    "detail_addr": "可莉不知道哦",
    "phone": "114514",
    "img": "https://hangeat.oss-cn-beijing.aliyuncs.com/media/restaurant/default.png",
    "created_at": "2023-12-11T08:44:06.123Z",
    "updated_at": "2023-12-11T08:44:06.123Z",
    "creator": 1,
    "tags": [
        "湘菜",
        "斯哈斯哈",
        "好辣好辣"
    ],
    "collectors_num": 2,
    "is_collected": true
}
```

#### 更新餐馆信息 update_restaurant/{id} [put]

```json
{
    "name": "餐馆名",
    "description": "餐馆描述",
    "address": "餐馆地址",
    "phone": "餐馆电话"
}
```

#### 上传餐馆图像 update-image/{id} [post]

- Form-data的格式，key是'image'

#### 删除餐馆 delete-restaurant/{id} [delete]

- 删除餐馆时，同时删除餐馆下的所有帖子
- 需要验证用户是否有权限删除


### tag restaurant/

#### 创建或者附加tag refer-tag [post]

```json
{
    "target_id": "目标id",
    "tags": ["tag1", "tag2", "tag3"]
}
```

- 已有tag会附加，没有的会创建

#### 删除tag delete-tag [delete]

```json
{
    "target_id": "目标id",
    "tag_name": "tag_name"
}
```

#### 得到tag数量 get-tag-num [get]

#### 得到tag列表 get-tag-list?from=&to= [get]

### Post

#### 创建帖子 create-post [post]

```json
{
    "restaurant_id": "餐馆id",
    "title": "帖子标题",
    "content": "帖子内容",
    "grade": "评分",
    "price": "int值"
}
```
- 评分只能是数字(0, '未评分'), (1, '一星'), (2, '二星'), (3, '三星'), (4, '四星'), (5, '五星')
- 可选参数 `"image": "图片url"`，用upload之后返回的那个。

#### upload图片 upload-image [post]

- Form-data的格式，key是'image'
- 格式只能是jpg，png，gif

#### 获取帖子数量 get-post-num/<int:target_id> [get]

- 无参数
- 返回示例：
```json
{
    "post_num": 1
}
```

#### 获取帖子列表 get-post-list/<int:target_id>?from=&to= [get]

- 返回示例：
```json
{
    "all_num": 2,
    "query_cnt": 2,
    "list": [
        {
            "id": 2,
            "title": "我是标题",
            "grade": 5,
            "avg_price": 66,
            "image": "https://hangeat.oss-cn-beijing.aliyuncs.com/media/post_image/default.png",
            "creator": 1,
            "agrees": 0,
            "is_agreed": false
        },
        {
            "id": 1,
            "title": "帖子标题",
            "grade": 5,
            "avg_price": 50,
            "image": "https://hangeat.oss-cn-beijing.aliyuncs.com/media/post_image/default.png",
            "creator": 1,
            "agrees": 1,
            "is_agreed": true
        }
    ]
}
```

#### 获取热门贴 get-post-list/<int:target_id> [get]

- 不需要from和to，会自动返回点赞前5的帖子，点赞相等按时间排序
- 格式和上面一样

#### 获取帖子详细信息 get-post-detail/<int:post_id> [get]

- 返回示例：
```json
{
    "id": 1,
    "title": "帖子标题",
    "content": "帖子内容啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊",
    "grade": 5,
    "avg_price": 50,
    "image": "https://hangeat.oss-cn-beijing.aliyuncs.com/media/post_image/default.png",
    "restaurant": 1,
    "creator": 1,
    "date": "2023-12-22T08:46:16.601Z",
    "recommend_dish": [],
    "agrees": 1,
    "is_agreed": true
}
```
- recommend_dish现在还没有用（

#### agree帖子 agree-post/<int:post_id> [post]

- 注意是post

#### disagree帖子 disagree-post/<int:post_id> [post]

- 注意是post

#### 删除帖子 delete-post/<int:post_id> [delete]

#### 更新帖子 update-post/<int:post_id> [put]

```json
{
    "title": "帖子标题",
    "content": "帖子内容",
    "grade": "评分",
    "price": "int值",
    "image": "图片url"
}
```

### comment

#### 创建评论 create-comment [post]

```json
{
    "post_id": "帖子id",
    "content": "评论内容"
}
```

- 可选参数 `"reply_id": "回复的评论id"`，当不设置时，表示为帖子的顶层评论，否则表示回复的评论

#### 获取评论数量 get-comment-num/<int:post_id> [get]

#### 获取评论列表 get-comment-list/<int:post_id>?from=&to= [get]

- 这里的逻辑稍微有点不一样
- 获取的数量和评论的列表都是reply_to为null的评论，即顶层评论。
- 但是返回的列表是顶层评论和顶层评论下的所有评论。
- 但是这里的顺序最好调整一下，加个代办叭
- 返回示例：

```json
{
    "all_num": 2,
    "query_cnt": 2,
    "list": [
        {
            "id": 1,
            "content": "评论内容",
            "author": 1,
            "reply_to": null,
            "agrees": 0,
            "is_agreed": false,
            "replies": [
                {
                    "id": 3,
                    "content": "评论内容",
                    "author": 1,
                    "reply_to": 1,
                    "agrees": 1,
                    "is_agreed": true
                },
                {
                    "id": 5,
                    "content": "3说的是个啥呀",
                    "author": 1,
                    "reply_to": 3,
                    "agrees": 0,
                    "is_agreed": false
                }
            ]
        },
        {
            "id": 2,
            "content": "评论内容",
            "author": 1,
            "reply_to": null,
            "agrees": 1,
            "is_agreed": true,
            "replies": [
                {
                    "id": 4,
                    "content": "aaaaaaaaa",
                    "author": 1,
                    "reply_to": 2,
                    "agrees": 0,
                    "is_agreed": false
                }
            ]
        }
    ]
}
```

#### 评论点赞 agree-comment/<int:comment_id> [post]

#### 评论取消点赞 disagree-comment/<int:comment_id> [post]

#### 删除评论 delete-comment/<int:comment_id> [delete]

#### 更新评论 update-comment/<int:comment_id> [put]

```json
{
    "content": "评论内容"
}
```

### 首页广场

#### 获取餐馆列表 get-restaurant-list/<int:order_type>?from=&to=&reverse=

- 支持lazy_load
- 排序方式支持：(0, 收藏人数排序)，(1, 平均评分排序)，(2, 平均价格排序)，(3, 时间排序)
- reverse：(0, 降序排列)，(1, 升序排列)
- 可选参数：
  - "creator_id="：根据创建者来筛选
  - "tags=tag1,tag2..."：根据tag来筛选，与逻辑
  - get-num可以指定上面两个筛选参数
